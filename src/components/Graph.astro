---
// Graph component with pinch-to-zoom functionality
// Displays a waveform/frequency graph that can be zoomed and panned

function generateWaveformPath() {
	let path = 'M 0,200';
	for (let i = 0; i <= 2000; i += 5) {
		const x = i;
		const y = 200 + Math.sin(i * 0.02) * 50 + Math.sin(i * 0.05) * 30 + Math.sin(i * 0.1) * 20;
		path += ` L ${x},${y}`;
	}
	return path;
}

const waveformPath = generateWaveformPath();
---

<div class="graph-container">
	<div id="graph" class="graph-content">
		<svg class="graph-svg" viewBox="0 0 2000 400" preserveAspectRatio="none">
			<!-- Background -->
			<rect x="0" y="0" width="2000" height="400" fill="var(--bg-secondary)" />
			
			<!-- Grid -->
			<defs>
				<pattern id="graph-grid" width="100" height="40" patternUnits="userSpaceOnUse">
					<path d="M 100 0 L 0 0 0 40" fill="none" stroke="var(--border-light)" stroke-width="0.5" opacity="0.3"/>
				</pattern>
			</defs>
			<rect x="0" y="0" width="2000" height="400" fill="url(#graph-grid)" />
			
			<!-- Axes -->
			<line x1="0" y1="200" x2="2000" y2="200" stroke="var(--text-secondary)" stroke-width="2" opacity="0.5"/>
			<line x1="0" y1="0" x2="0" y2="400" stroke="var(--text-secondary)" stroke-width="2" opacity="0.5"/>
			
			<!-- Axis labels -->
			<text x="50" y="20" fill="var(--text-secondary)" font-size="14" text-anchor="middle">Amplitude</text>
			<text x="1950" y="390" fill="var(--text-secondary)" font-size="14" text-anchor="middle">Time (s)</text>
			
			<!-- Frequency markers -->
			<g class="frequency-markers">
				{Array.from({ length: 21 }, (_, i) => {
					const y = i * 20;
					const value = 100 - (i * 5);
					return (
						<>
							<line x1="0" y1={y} x2="2000" y2={y} stroke="var(--border-light)" stroke-width="0.5" opacity="0.2"/>
							{i % 5 === 0 && <text x="30" y={y + 5} fill="var(--text-secondary)" font-size="10">{value}%</text>}
						</>
					);
				})}
			</g>
			
			<!-- Time markers -->
			<g class="time-markers">
				{Array.from({ length: 21 }, (_, i) => {
					const x = i * 100;
					return (
						<>
							<line x1={x} y1="0" x2={x} y2="400" stroke="var(--border-light)" stroke-width="0.5" opacity="0.2"/>
							{i % 5 === 0 && <text x={x} y="395" fill="var(--text-secondary)" font-size="10" text-anchor="middle">{i}s</text>}
						</>
					);
				})}
			</g>
			
			<!-- Waveform data (sine wave example) -->
			<path 
				class="waveform" 
				d={waveformPath} 
				fill="none" 
				stroke="var(--primary)" 
				stroke-width="3"
			/>
			
			<!-- Frequency spectrum (bars) -->
			<g class="frequency-bars">
				{Array.from({ length: 50 }, (_, i) => {
					const x = i * 40;
					const height = 50 + Math.sin(i * 0.3) * 30;
					const y = 200 - height / 2;
					return (
						<rect 
							x={x} 
							y={y} 
							width="30" 
							height={height} 
							fill="var(--accent)" 
							opacity="0.6"
						/>
					);
				})}
			</g>
			
			<!-- Cursor/playhead -->
			<line 
				id="graph-cursor" 
				x1="500" 
				y1="0" 
				x2="500" 
				y2="400" 
				stroke="var(--accent)" 
				stroke-width="2"
			/>
		</svg>
	</div>
	
	<!-- Zoom controls -->
	<div class="graph-controls">
		<button id="graph-zoom-in" class="zoom-button" aria-label="Zoom in">
			<svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
			</svg>
		</button>
		<button id="graph-zoom-out" class="zoom-button" aria-label="Zoom out">
			<svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
			</svg>
		</button>
		<button id="graph-reset" class="zoom-button" aria-label="Reset zoom">
			<svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
			</svg>
		</button>
	</div>
</div>

<style>
	.graph-container {
		position: relative;
		width: 100%;
		height: 400px;
		background: var(--bg-secondary);
		border-radius: 8px;
		overflow: hidden;
		border: 1px solid var(--border-light);
	}

	.graph-content {
		width: 100%;
		height: 100%;
		overflow: hidden;
		position: relative;
	}

	.graph-svg {
		width: 100%;
		height: 100%;
		display: block;
	}

	.graph-controls {
		position: absolute;
		top: 8px;
		right: 8px;
		display: flex;
		gap: 4px;
		z-index: 10;
	}

	.zoom-button {
		width: 32px;
		height: 32px;
		display: flex;
		align-items: center;
		justify-content: center;
		background: var(--bg-primary);
		border: 1px solid var(--border-light);
		border-radius: 4px;
		color: var(--text-primary);
		cursor: pointer;
		transition: all 0.2s;
	}

	.zoom-button:hover {
		background: var(--bg-secondary);
		border-color: var(--primary);
	}

	.zoom-button:active {
		transform: scale(0.95);
	}

	@media (prefers-color-scheme: dark) {
		.zoom-button {
			background: rgba(255, 255, 255, 0.1);
			border-color: rgba(255, 255, 255, 0.2);
		}
	}
</style>

<script>
	import { PinchZoom } from '../utils/pinchZoom';

	document.addEventListener('DOMContentLoaded', () => {
		const graphElement = document.getElementById('graph');
		if (!graphElement) return;

		const pinchZoom = new PinchZoom(graphElement, {
			minScale: 0.5,
			maxScale: 5,
			initialScale: 1,
		});

		// Zoom controls
		const zoomInBtn = document.getElementById('graph-zoom-in');
		const zoomOutBtn = document.getElementById('graph-zoom-out');
		const resetBtn = document.getElementById('graph-reset');

		zoomInBtn?.addEventListener('click', () => {
			const currentScale = pinchZoom.getScale();
			pinchZoom.setScale(Math.min(5, currentScale * 1.2));
		});

		zoomOutBtn?.addEventListener('click', () => {
			const currentScale = pinchZoom.getScale();
			pinchZoom.setScale(Math.max(0.5, currentScale / 1.2));
		});

		resetBtn?.addEventListener('click', () => {
			pinchZoom.reset();
		});

		// Cleanup on page unload
		window.addEventListener('beforeunload', () => {
			pinchZoom.destroy();
		});
	});
</script>
